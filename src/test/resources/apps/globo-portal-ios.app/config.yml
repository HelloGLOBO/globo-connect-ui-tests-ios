commands:

  get-certificates-command:
    description: Start Services
    steps:
      - run:
          name: decode Certificates
          context: org-global
          command: base64 -D -o Certificates.p12 \<<< $Certificates
      - run:
          name: make Provisioning Profiles directory
          command: mkdir -pv ~/Library/MobileDevice/Provisioning\ Profiles/
      - run:
          name: decode Provisioning Profiles
          context: org-global
          command: base64 -D -o ~/Library/MobileDevice/Provisioning\ Profiles/App_Store.mobileprovision \<<< $MobileProvision
      - run:
          name: decode Ad Hoc Provisioning Profiles
          context: org-global
          command: base64 -D -o ~/Library/MobileDevice/Provisioning\ Profiles/App_Store_Ad_Hoc.mobileprovision \<<< $MobileProvisionAdHoc
      - run:
          name: decode Dev Provisioning Profiles
          context: org-global
          command: base64 -D -o ~/Library/MobileDevice/Provisioning\ Profiles/App_Store_DEV.mobileprovision \<<< $MobileProvisionDev

  setup-build-tools-command:
    description: Installs dependencies
    steps:
      # Set up xcbeautify, Fastlane Restore & Cache
      - run: brew install xcbeautify
      - restore_cache:
          key: v2.1-bundle-cache-{{ checksum "Gemfile.lock" }}
      - run: bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=4 --retry=3
      - save_cache:
          key: v2.1-bundle-cache-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle

      # Set up Pods and restore ca
      - restore_cache:
          key: v2.1-pods-cache-{{ checksum "Podfile" }}
      - run:
          name: Pod Install
          command: bundle exec fastlane run cocoapods
      - save_cache:
          key: v2.1-pods-cache-{{ checksum "Podfile" }}
          paths:
            - Pods

  generate-build-command:
    description: Generate Build and Cache derived_data
    parameters:
      lane:
        description: The lane to use for building ipa
        type: string
        default: "development_ci_fast"
    steps:
      - restore_cache:
          key: v2.1-derived-data-cache-{{ .Branch }}-{{ checksum "Podfile.lock" }}
      - run:
          name: Compile Build
          command: |
            mkdir -p ./build/derived_data
            bundle exec fastlane << parameters.lane >>
      - save_cache:
          key: v2.1-derived-data-cache-{{ .Branch }}-{{ checksum "Podfile.lock" }}
          paths:
            - ./build/derived_data

  upload-builds-command:
    description: Upload all builds in output dir
    steps:
      - run:
          name: Fastlane Upload Builds
          command: bundle exec fastlane upload_all
      - store_artifacts:
          path: ./build/ipas
      - store_artifacts:
          path: ./build/tests

  health-coverage-command:
    description: Runs ruby script to validate merge order stats
    steps:
      - run:
          name: Setup Coverage Result
          when: always
          command: |
            export STATS_RESULT=$(ruby ./.circleci/main_stats_checker.rb)
            echo "Stats Result: $STATS_RESULT"
            echo 'export STATS_RESULT="$(ruby ./.circleci/main_stats_checker.rb)"' >> "$BASH_ENV"
      - slack/notify:
          channel: "#circle_ci_alerts"
          event: always
          custom: |
            {
              "attachments": [
                {
                  "fallback": "GLOBO Repo Health Check Report",
                  "text": "$STATS_RESULT",
                  "fields": [
                    {
                      "title": "Project",
                      "value": "$CIRCLE_PROJECT_REPONAME",
                      "short": true
                    },
                    {
                      "title": "Job Number",
                      "value": "$CIRCLE_BUILD_NUM",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "$CIRCLE_BRANCH",
                      "short": true
                    }
                  ],
                  "actions": [
                    {
                      "type": "button",
                      "text": "Visit Job",
                      "url": "$CIRCLE_BUILD_URL"
                    }
                  ],
                  "color": "#5898E3"
                }
              ]
            }

  store-tests-command:
    description: Store test files
    steps:
      - store_artifacts:
          path: ./build/tests
      - store_artifacts:
          path: ./build/slather
      - store_test_results:
          path: ./build/tests

  run-test-lane-command:
    description: Run a specific test lane
    parameters:
      scheme:
        description: The scheme to use for the test lane
        type: string
        default: "development_unit_tests"
    steps:
      - generate-build-command:
          lane: << parameters.scheme >>

  run-coverage-command:
    description: Run code coverage
    steps:
      - run:
          name: Grab Code Coverage
          command: |
            # upload code coverage to Coveralls
            bundle exec fastlane run slather scheme:"globo-portal-ios" proj:"globo-portal-ios.xcodeproj" workspace:"globo-portal-ios.xcworkspace" build_directory:"./build/derived_data" output_directory:"./build/slather" html:true circleci:true coveralls:true

            # build html artifact
            bundle exec fastlane run slather scheme:"globo-portal-ios" proj:"globo-portal-ios.xcodeproj" workspace:"globo-portal-ios.xcworkspace" build_directory:"./build/derived_data" output_directory:"./build/slather" html:true circleci:true 

            # build simple output to store on ENV variable
            export COVERAGE=$(bundle exec fastlane run slather scheme:"globo-portal-ios" proj:"globo-portal-ios.xcodeproj" workspace:"globo-portal-ios.xcworkspace" build_directory:"./build/derived_data" output_directory:"./build/slather" circleci:true simple_output:true | grep "Test Coverage" | tail -1)
            
            # create dir for storing coverage
            mkdir -p ./build/cov/
            echo $COVERAGE > ./build/cov/coverage.txt

      - save_cache:
          key: v2.1-coverage-cache-{{ .Revision }}
          paths:
            - build/cov
      - store-tests-command

orbs:
  slack: circleci/slack@5.1.1
   
version: 2.1
jobs:

  default-runner-job: &default-runner-job
    macos:
      xcode: 16.4.0
    resource_class: m4pro.medium
    steps: &default-runner-job-steps
      - checkout
      - get-certificates-command
      - setup-build-tools-command

  run-tests:
    <<: *default-runner-job 
    steps:
      - checkout
      - get-certificates-command
      - setup-build-tools-command
      - run-test-lane-command:
          scheme: development_unit_tests
      - run-test-lane-command:
          scheme: development_ui_tests
      - run-coverage-command
      - store-tests-command

  build-release:
    <<: *default-runner-job
    steps:
      - checkout
      - get-certificates-command
      - setup-build-tools-command
      - generate-build-command:
          lane: appstore_release_ci_fast

  build-production:
    <<: *default-runner-job
    steps:
      - checkout
      - get-certificates-command
      - setup-build-tools-command
      - generate-build-command:
          lane: production_ci_fast
      - upload-builds-command

  build-staging:
    <<: *default-runner-job
    steps:
      - checkout
      - get-certificates-command
      - setup-build-tools-command
      - generate-build-command:
          lane: staging_ci_fast
      - upload-builds-command
      - run:
            no_output_timeout: 30m
            command: bundle exec fastlane staging_ci_saucelabs_ui_tests
      
  build-uat:
    <<: *default-runner-job
    steps:
      - checkout
      - get-certificates-command
      - setup-build-tools-command
      - generate-build-command:
          lane: uat_ci_fast
      - upload-builds-command
      - run:
            no_output_timeout: 30m
            command: bundle exec fastlane uat_ci_saucelabs_ui_tests

  build-qa:
    <<: *default-runner-job
    steps:
      - checkout
      - get-certificates-command
      - setup-build-tools-command
      - generate-build-command:
          lane: qa_ci_fast
      - upload-builds-command
      - run:
            no_output_timeout: 30m
            command: bundle exec fastlane qa_ci_saucelabs_ui_tests

  build-demo:
    <<: *default-runner-job
    steps:
      - checkout
      - get-certificates-command
      - setup-build-tools-command
      - generate-build-command:
          lane: demo_ci_fast
      - upload-builds-command
      - run:
            no_output_timeout: 30m
            command: bundle exec fastlane demo_ci_saucelabs_ui_tests

  prepare-caches:
    <<: *default-runner-job
    steps:
      - checkout
      - get-certificates-command
      - setup-build-tools-command

  ios-repo-health-job:
    <<: *default-runner-job
    steps:
      - checkout
      - restore_cache:
          key: v2.1-coverage-cache-{{ .Revision }}
      - health-coverage-command

workflows:
  build-upload-apps:
    jobs:
      - build-release
      - build-demo
      - build-production
      - build-uat
      - build-staging
      - build-qa

  test-builds:
    jobs:
      - run-tests
  
  health-workflow:
    jobs:
      - ios-repo-health-job
    triggers:
      - schedule:
          cron: "0 14,21 * * *" # 2 PM and 8 PM UTC (10 AM and 4 PM EST)
          filters:
            branches:
              only:
                - master
